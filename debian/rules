#!/usr/bin/make -f

# Enable all hardening options
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

# Set HOME for cargo (Launchpad builds need this)
export HOME = /tmp/build-home
export CARGO_HOME = $(HOME)/.cargo

%:
	dh $@

override_dh_auto_configure:
	# Create temporary home directory for cargo
	mkdir -p $(CARGO_HOME)
	# Verify rust toolchain is available
	rustc --version
	cargo --version

override_dh_auto_build:
	# Build the project
	# If Cargo.lock is lockfile v4, regenerate with Cargo 1.75 (produces v3)
	if grep -q '^version = 4' Cargo.lock 2>/dev/null; then \
		rm -f Cargo.lock; \
		cargo generate-lockfile; \
	fi
	# Build the project with cargo
	cargo build --release --locked

override_dh_auto_install:
	# Install the compiled binary
	install -D -m 0755 target/release/all-smi debian/all-smi/usr/bin/all-smi

override_dh_auto_test:
	# Skip tests to save build time on Launchpad
	@echo "Skipping tests for PPA build"

override_dh_auto_clean:
	# Don't run dh_auto_clean as it requires cargo to be installed
	# Just clean the build artifacts manually
	rm -rf target/ $(HOME)

override_dh_builddeb:
	dh_builddeb --destdir=../